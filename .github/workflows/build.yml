name: Build SRS Rule-Set

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  compile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Download & verify sing-box
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y jq wget
          SB_VER=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r .tag_name)
          echo "Latest version: $SB_VER"
          DOWNLOAD_URL="https://github.com/SagerNet/sing-box/releases/download/${SB_VER}/sing-box-${SB_VER}-linux-amd64.tar.gz"
          echo "Download URL: $DOWNLOAD_URL"
          wget -O sing-box.tar.gz "$DOWNLOAD_URL"
          file sing-box.tar.gz
          ls -lh sing-box.tar.gz
          tar -xzf sing-box.tar.gz
          # 如果解压出来是一个目录 lib 或 bin，可以改路径
          chmod +x sing-box

      - name: Compile JSON -> SRS
        run: |
          set -eux
          ./sing-box rule-set compile --output Filters/AWAvenue-Ads-Rule-Singbox.srs Filters/AWAvenue-Ads-Rule-Singbox.json

      - name: Commit & push if changed
        run: |
          set -eux
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Filters/AWAvenue-Ads-Rule-Singbox.srs
          if ! git diff --cached --quiet; then
            git commit -m "Update SRS at $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
          else
            echo "No changes to SRS"
