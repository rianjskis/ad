name: Build SRS Rule-Set

on:
  schedule:
    - cron: "0 0 * * *"   # 每天 00:00 UTC 执行一次（你可以改为适合的时区 /频率）
  workflow_dispatch:     # 手动触发也可以

jobs:
  compile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          # 如果你要提交回当前分支，需要开启 write 权限
          persist-credentials: true
          fetch-depth: 0

      - name: Download latest sing-box release
        # 这里假设 sing-box 发布的是在 GitHub Releases，你可以用 actions/download-release-artifact、或者直接从官网抓
        run: |
          # 以示例方式下载 Linux 版本，你需要根据你的目标平台调整
          SB_VER=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r .tag_name)
          wget -qO sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/$SB_VER/sing-box-$SB_VER-linux-amd64.tar.gz"
          tar -xzf sing-box.tar.gz
          chmod +x sing-box

      - name: Compile JSON -> SRS
        run: |
          # 假设你的 JSON 在 Filters/
          ./sing-box rule-set compile --output Filters/AWAvenue-Ads-Rule-Singbox.srs Filters/AWAvenue-Ads-Rule-Singbox.json

      - name: Commit and push changes
        run: |
          # 如果 .srs 有变化，则提交
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Filters/AWAvenue-Ads-Rule-Singbox.srs
          if ! git diff --cached --quiet; then
            git commit -m "Update SRS at $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
          else
            echo "No changes to SRS"
          fi
